#!/bin/bash
export MALLOC_ARENA_MAX=4
export MASTER_NODE_ADDR=`sed -n 's/.*<name>yarn.resourcemanager.address<\/name><value>\(.*\):\(.*\)<\/value>.*/\1/p' $HADOOP_CONF_DIR/yarn-site.xml` 
export JARS_TO_SHIP="`ls -1 $SPARK_HOME/lib/* | grep -v spark-assembly | tr '\n' ','`$SPARK_CONF_DIR/hive-site.xml"
export SPARK_SUBMIT_OPTS="-Djava.io.tmpdir=$CURRENT_JOB_TMP_DIR -cp $SPARK_HOME/lib/*:$($HADOOP_HOME/bin/hadoop classpath)"

exec $SPARK_HOME/bin/spark-submit \
    --conf spark.yarn.historyServer.address=$MASTER_NODE_ADDR:18080 \
    --conf spark.s3.use.instance.credentials=true \
    --jars $JARS_TO_SHIP \
    --deploy-mode cluster \
    --driver-java-options -XX:MaxPermSize=512m \
    --driver-memory 5120m \
    --properties-file $SPARK_HOME/conf/spark-defaults.conf \
    $@
