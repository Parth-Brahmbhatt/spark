#!/bin/bash
export MALLOC_ARENA_MAX=4
export MASTER_NODE_ADDR=`sed -n 's/.*<name>yarn.resourcemanager.address<\/name><value>\(.*\):\(.*\)<\/value>.*/\1/p' $HADOOP_CONF_DIR/yarn-site.xml` 
export SPARK_DRIVER_CLASSPATH="$SPARK_CONF_DIR:$SPARK_HOME/lib/*:$($HADOOP_HOME/bin/hadoop classpath)"
export SPARK_LOCAL_HOSTNAME=$EC2_HOSTNAME

# When spark shell runs on genie, SPARK_LOG_DIR/FILE are not set
if [ -z "$SPARK_LOG_DIR" ]
then
    export SPARK_LOG_DIR=$CURRENT_JOB_TMP_DIR
fi
if [ -z "$SPARK_LOG_FILE" ]
then
    export SPARK_LOG_FILE="sparkshell.log"
fi

mkdir -p $SPARK_LOG_DIR
export SPARK_LOG_FILE_PATH=$SPARK_LOG_DIR/$SPARK_LOG_FILE
>&2 echo "Spark client logs are located at $SPARK_LOG_FILE_PATH"

exec $SPARK_HOME/bin/$1 \
    --conf spark.driver.host=$EC2_HOSTNAME \
    --conf spark.yarn.historyServer.address=$MASTER_NODE_ADDR:18080 \
    --driver-class-path $SPARK_DRIVER_CLASSPATH \
    --driver-java-options \
      "-Djava.io.tmpdir=$CURRENT_JOB_TMP_DIR -Dspark.log.path=$SPARK_LOG_FILE_PATH -Dlog4j.configuration=file:$SPARK_HOME/conf/log4j.properties" \
    --driver-memory 1500m \
    --properties-file $SPARK_HOME/conf/spark-defaults.conf \
    ${@:2}
