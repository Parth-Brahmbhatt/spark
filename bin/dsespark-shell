#!/bin/bash

#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

USER_ARGS=${@:2}
RE="--jars ([^ ]+)"
JARS_TO_SHIP="s3://atlas.us-east-1.prod.netflix.net/jars/atlas-hive.jar,$SPARK_CONF_DIR/hive-site.xml"
if [[ $USER_ARGS =~ $RE ]]
then
    JARS_TO_SHIP=$JARS_TO_SHIP,${BASH_REMATCH[1]}
    USER_ARGS=${USER_ARGS/${BASH_REMATCH[0]}/}
fi

export MASTER_NODE_ADDR=`sed -n 's/.*<name>yarn.resourcemanager.address<\/name><value>\(.*\):\(.*\)<\/value>.*/\1/p' $HADOOP_CONF_DIR/yarn-site.xml` 

# Handle new line character in emr4 yarn-site.xml 
if [ -z "$MASTER_NODE_ADDR" ]; then
    export MASTER_NODE_ADDR=`perl -0ne 'print $1 if m#<name>yarn.resourcemanager.hostname</name>\s*<value>(.*?)</value>#;' $HADOOP_CONF_DIR/yarn-site.xml`
fi

export SPARK_DRIVER_CLASSPATH="$SPARK_CONF_DIR:$SPARK_HOME/lib/*:$($HADOOP_HOME/bin/hadoop classpath)"
export MALLOC_ARENA_MAX=4

# When spark shell runs on genie, SPARK_LOG_DIR/FILE are not set
if [ -z "$SPARK_LOG_DIR" ]
then
    export SPARK_LOG_DIR=$CURRENT_JOB_TMP_DIR
fi
if [ -z "$SPARK_LOG_FILE" ]
then
    export SPARK_LOG_FILE="sparkshell.log"
fi

mkdir -p $SPARK_LOG_DIR
export SPARK_LOG_FILE_PATH=$SPARK_LOG_DIR/$SPARK_LOG_FILE
>&2 echo "Spark client logs are located at $SPARK_LOG_FILE_PATH"

# Inspect CURRENT_JOB_WORKING_DIR and pull out genie job id if its a genie job
if [ "$(echo $CURRENT_JOB_WORKING_DIR|perl -F/ -ane 'print "$F[3]\n";')" == "genie-jobs" ]; then
   APPEND_GENIE_ID="--conf spark.genie.id=$(echo $CURRENT_JOB_WORKING_DIR|perl -F/ -ane 'print "$F[4]\n";')"
fi

exec $SPARK_HOME/bin/$1 \
    ${SPARK_CONFIG_OPTS:-} \
    --conf spark.yarn.historyServer.address=$MASTER_NODE_ADDR:18080 $APPEND_GENIE_ID  \
    --jars $JARS_TO_SHIP \
    --driver-class-path $SPARK_DRIVER_CLASSPATH \
    --driver-java-options \
      "-Djava.io.tmpdir=$CURRENT_JOB_TMP_DIR -Dspark.log.path=$SPARK_LOG_FILE_PATH -Dlog4j.configuration=file:$SPARK_HOME/conf/log4j.properties" \
    --driver-memory 1500m \
    --properties-file $SPARK_HOME/conf/spark-defaults.conf \
    $USER_ARGS
